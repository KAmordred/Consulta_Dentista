{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insumos</title>
    <!-- Enlace al archivo CSS de Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="{% static 'estilos.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/styleinsumos.css' %}">
    <style>
        .navbar-brand .navbar-logo {
            max-width: 60px; /* ajusta el ancho máximo de la imagen */
            height: 60px; /* mantiene la proporción de aspecto */
        }
        .text-start {
            text-align: left !important;
        }
    </style>
</head>
<body>
    <!-- Navbar superior -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img class="navbar-logo" src="{% static 'imagenes/Imagen LOgo copia.jpg' %}" alt="Logo"></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavCombined" aria-controls="navbarNavCombined" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavCombined">
                <div class="navbar-nav w-100 d-flex justify-content-between">
                    <form class="d-flex flex-grow-1" role="search">
                        <input class="form-control me-2 flex-grow-1" type="search" placeholder="Productos, marcas y más..." aria-label="Search">
                    </form>
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                        {% if user.is_authenticated %}
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">Cerrar sesión</a>
                                <!-- Formulario oculto para logout -->
                                <form id="logoutForm" action="{% url 'logout' %}" method="post" style="display: none;">
                                    {% csrf_token %}
                                </form>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'login' %}">Iniciar sesión <br>Mi cuenta</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'registro' %}">Registrarse </a>
                            </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">Carro</a>
                        </li>
                    </ul>
                    
                </div>
            </div>
        </div>
    </nav>
    <!-- Navbar inferior -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavCombined" aria-controls="navbarNavCombined" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavCombined">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{% url 'index' %}">Principal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'AVentaEquiposRX' %}">Productos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'insumos' %}">Comprar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'especialidades' %}">Especialidades</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'nosotros' %}">Nosotros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'contactanos' %}">Contáctanos</a>
                    </li>
                </ul>
                <div class="derecha ms-auto">
                    {% if user.is_authenticated %}
                        <strong><p>Bienvenido,<br> {{user.username}}</p></strong>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
    <!-- FINAL DE LA NAV BAR PARA TODAS LAS VISTAS -->

    <!--Logica de seccion de productos, acumular, sub total, iva y la migracion de los productos desde la BD-->
    <!-- Contenido principal -->
    <div class="insumos-page">
        <div class="container-lg">
            <!-- Aquí va el contenido de la página principal -->
            <div class="contenedor-principal">
                <div class="contenedor-productos">
                    {% if user.is_authenticated %}
                        <!-- Verificar si hay productos -->
                        {% if productos %}
                            <!-- Crear tarjetas de productos de la base de datos -->
                            {% for producto in productos %}
                                <div class="card">
                                    <!-- Verificar si el producto tiene una imagen -->
                                    {% if producto.imagen %}
                                        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
                                    {% else %}
                                        <img src="{% static 'images/default_product_image.jpg' %}" alt="Imagen por defecto">
                                    {% endif %}
                                    <div class="card-content">
                                        <h3>{{ producto.nombre }}</h3>
                                        <p>Precio: ${{ producto.precio|floatformat:1 }}</p>
                                        <button class="boton" onclick="agregarProductoAlCarrito('{{ producto.nombre }}', {{ producto.precio }})">Añadir al carrito</button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>No hay productos disponibles en este momento.</p>
                        {% endif %}
                    {% else %}
                        <p id="mensaje-sesion">Por favor, inicia sesión para comprar productos.</p>
                    {% endif %}
                </div>
                <div class="contenedor-carrito">
                    <h3>Tus productos seleccionados</h3>
                    <ul id="lista-carrito"></ul>
                    <p id="subtotal">Sub Total: $0</p>
                    <p id="iva">IVA 19%: $0</p>
                    <p id="total">Monto a pagar: $0</p>
                    <button class="boton-pagar" onclick="toggleCartOffcanvas()">Ir a pagar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Off-canvas CARRO -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
        <div class="offcanvas-header">
            <h4 class="offcanvas-title" id="cartOffcanvasLabel">Carrito de Compras</h4>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Contenido del carrito -->
            <div class="cart-container text-start">
                <div class="cart-preview">
                    <div class="cart-content">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="cart-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path>
                        </svg>
                        <p><strong>DETALLE</strong></p>
                    </div>
                </div>
            </div>
            <ul id="cart-items" class="text-start"></ul>
            <!-- Opciones de envío -->
            <p class="text-start"><strong>SELECCIONA TU OPCION DE DESPACHO</strong></p>
            <div class="form-check text-start">
                <input class="form-check-input" type="radio" name="envio" id="retiroTienda" value="retiro" checked>
                <label class="form-check-label" for="retiroTienda">Retiro en tienda ($0) <br> <strong>Region Metropolitana($0)</strong> </label>
            </div>
            <div class="form-check text-start">
                <br>
                <input class="form-check-input" type="radio" name="envio" id="despachoDomicilio" value="despacho">
                <label class="form-check-label" for="despachoDomicilio">Despacho a domicilio (+$4.500)</label>
            </div>
            <!-- Resumen del carrito -->
            <p id="cart-subtotal" class="text-start">Sub Total: $0</p>
            <p id="cart-iva" class="text-start">IVA (19%): $0</p>
            <p id="cart-total" class="text-start">Monto a pagar: $0</p>
            <button class="cart-button" onclick="simularPago()">Pagar Total</button>
        </div>
    </div>

    <!-- Scripts de JavaScript al final del cuerpo para un mejor rendimiento -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        let carrito = [];
        let recargoEnvio = 0;

        // Función para mostrar u ocultar el offcanvas del carrito
        function toggleCartOffcanvas() {
            var offcanvasElement = document.getElementById('cartOffcanvas');
            var offcanvas = new bootstrap.Offcanvas(offcanvasElement);
            offcanvas.toggle();
            actualizarCarritoOffcanvas();
        }

        // Función para agregar producto al carrito
        function agregarProductoAlCarrito(nombre, precio) {
            // Buscar si el producto ya está en el carrito
            let encontrado = false;
            carrito.forEach((producto) => {
                if (producto.nombre === nombre) {
                    producto.cantidad++;
                    encontrado = true;
                }
            });
            // Si el producto no está en el carrito, agregarlo
            if (!encontrado) {
                carrito.push({ nombre: nombre, precio: precio, cantidad: 1 });
            }
            actualizarCarrito();
            guardarCarritoEnLocalStorage();
            actualizarCarritoOffcanvas();
        }

        // Función para actualizar el carrito y calcular el subtotal, iva y total
        function actualizarCarrito() {
            const listaCarrito = document.getElementById('lista-carrito');
            let subtotal = 0;
            listaCarrito.innerHTML = '';
            carrito.forEach((producto) => {
                const item = document.createElement('li');
                item.textContent = `${producto.cantidad} x ${producto.nombre} - $${producto.precio * producto.cantidad}`;
                const botonEliminar = document.createElement('button');
                botonEliminar.textContent = 'Eliminar';
                botonEliminar.classList.add('boton-eliminar');
                botonEliminar.onclick = () => eliminarProductoDelCarrito(producto);
                item.appendChild(botonEliminar);
                listaCarrito.appendChild(item);
                subtotal += producto.precio * producto.cantidad;
            });
            const iva = subtotal * 0.19;
            const total = subtotal + iva + recargoEnvio;
            document.getElementById('subtotal').textContent = `Sub Total: $${subtotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `IVA 19%: $${iva.toFixed(2)}`;
            document.getElementById('total').textContent = `Monto a pagar: $${total.toFixed(2)}`;
        }

        // Función para eliminar un producto del carrito
        function eliminarProductoDelCarrito(producto) {
            const index = carrito.indexOf(producto);
            if (index !== -1) {
                carrito.splice(index, 1);
                actualizarCarrito();
                guardarCarritoEnLocalStorage();
                actualizarCarritoOffcanvas();
            }
        }

        // Función para simular el pago (ejemplo)
        function simularPago() {
            alert('Pago realizado con éxito');
            vaciarCarrito();
        }

        // Función para guardar el carrito en localStorage
        function guardarCarritoEnLocalStorage() {
            localStorage.setItem('carrito', JSON.stringify(carrito));
        }

        // Función para cargar el carrito desde localStorage al cargar la página
        function cargarCarritoDesdeLocalStorage() {
            const carritoGuardado = localStorage.getItem('carrito');
            if (carritoGuardado) {
                carrito = JSON.parse(carritoGuardado);
                actualizarCarrito();
            }
        }

        // Función para vaciar el carrito
        function vaciarCarrito() {
            carrito = [];
            actualizarCarrito();
            localStorage.removeItem('carrito');
            actualizarCarritoOffcanvas();
        }

        // Función para actualizar el carrito en el offcanvas
        function actualizarCarritoOffcanvas() {
            const cartItemsList = document.getElementById('cart-items');
            cartItemsList.innerHTML = '';
            let subtotal = 0;
            carrito.forEach(producto => {
                const cartItem = document.createElement('li');
                cartItem.textContent = `${producto.cantidad} x ${producto.nombre} - $${producto.precio * producto.cantidad}`;
                cartItemsList.appendChild(cartItem);
                subtotal += producto.precio * producto.cantidad;
            });

            const iva = subtotal * 0.19;
            const total = subtotal + iva + recargoEnvio;

            document.getElementById('cart-subtotal').textContent = `Sub Total: $${subtotal.toFixed(2)}`;
            document.getElementById('cart-iva').textContent = `IVA (19%): $${iva.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `Monto a pagar: $${total.toFixed(2)}`;
        }

        // Función para actualizar el total a pagar basado en la opción de envío
        function actualizarTotalConEnvio() {
            const envio = document.querySelector('input[name="envio"]:checked').value;
            recargoEnvio = (envio === 'despacho') ? 4500 : 0;
            actualizarCarritoOffcanvas();
        }

        // Evento que se ejecuta al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            cargarCarritoDesdeLocalStorage();
            actualizarCarritoOffcanvas(); // Actualiza el carrito en el offcanvas al cargar la página
            document.getElementById('retiroTienda').addEventListener('change', actualizarTotalConEnvio);
            document.getElementById('despachoDomicilio').addEventListener('change', actualizarTotalConEnvio);
        });
    </script>
</body>
</html>